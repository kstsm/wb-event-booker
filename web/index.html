<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventBooker - Список мероприятий</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            margin-bottom: 20px;
            color: #333;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            margin-right: 15px;
            text-decoration: none;
            color: #007bff;
        }
        .nav a:hover {
            text-decoration: underline;
        }
        .events-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .event-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .event-card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .event-card p {
            margin: 5px 0;
            color: #666;
        }
        .event-card .seats {
            font-weight: bold;
            color: #28a745;
        }
        .event-card .seats.no-seats {
            color: #dc3545;
        }
        .event-card.expired {
            opacity: 0.6;
            background: #f8f9fa;
        }
        .event-card.expired .expired-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #dc3545;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .event-card .active-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .event-card .no-seats-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #fddd7b;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .event-card a {
            display: inline-block;
            margin-top: auto;
            padding: 8px 16px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            width: fit-content;
        }
        .event-card a:hover {
            background: #0056b3;
        }
        .event-card.expired a {
            background: #6c757d;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EventBooker - Список мероприятий</h1>
        <div class="nav">
            <a href="/">Главная</a>
            <a href="/register">Регистрация</a>
            <a href="/admin">Админ панель</a>
        </div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Загрузка мероприятий...</div>
        <div id="events-list" class="events-list"></div>
    </div>

    <script>
        loadEvents();

        async function loadEvents() {
            try {
                const response = await fetch('/api/events');
                const respText = await response.text();
                let json = null;
                try { json = respText ? JSON.parse(respText) : null; } catch {}
                
                if (!response.ok) {
                    const errorMsg = (json && json.error) ? (json.error) : ('HTTP ' + response.status);
                    showError(errorMsg);
                    return;
                }
                
                const data = json || {};
                displayEvents(data.events || []);
            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayEvents(events) {
            const container = document.getElementById('events-list');
            if (events.length === 0) {
                container.innerHTML = '<p>Нет доступных мероприятий</p>';
                return;
            }

            const now = new Date();
            container.innerHTML = events.map(event => {
                const availableSeats = event.total_seats - event.reserved_seats - event.booked_seats;
                const date = new Date(event.date).toLocaleString('ru-RU');
                const eventDate = new Date(event.date);
                const isExpired = eventDate < now;
                const expiredClass = isExpired ? 'expired' : '';
                
                let statusBadge = '';
                if (isExpired) {
                    statusBadge = '<span class="expired-badge">ПРОСРОЧЕНО</span>';
                } else if (availableSeats <= 0) {
                    statusBadge = '<span class="no-seats-badge">МЕСТ НЕТ</span>';
                } else {
                    statusBadge = '<span class="active-badge">ДОСТУПНО</span>';
                }
                
                const eventTypeBadge = event.requires_payment_confirmation 
                    ? '<p><strong>Тип:</strong> Требует подтверждение бронирование</p>' 
                    : '<p><strong>Тип:</strong> Без подтверждения бронирования</p>';
                
                const seatsClass = availableSeats <= 0 ? 'seats no-seats' : 'seats';
                
                return `
                    <div class="event-card ${expiredClass}">
                        ${statusBadge}
                        <h3>${event.name}</h3>
                        <p><strong>Дата:</strong> ${date}</p>
                        ${eventTypeBadge}
                        <p><strong>Всего мест:</strong> ${event.total_seats}</p>
                        <p class="${seatsClass}"><strong>Свободно:</strong> ${availableSeats}</p>
                        <a href="/event?id=${event.id}">Подробнее</a>
                    </div>
                `;
            }).join('');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
